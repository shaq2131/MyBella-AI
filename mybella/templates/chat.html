{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card h-100 border-0">
        <div class="card-header d-flex justify-content-between align-items-center py-3">
          <div class="d-flex align-items-center gap-3">
            <div class="companion-avatar {{ persona|default('isabella')|lower }}">
              {% if persona|default('isabella')|lower == 'isabella' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1v-1c0-1-1-4-6-4s-6 3-6 4v1a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12z"/>
              </svg>
              {% elif persona|lower == 'emma' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
              </svg>
              {% elif persona|lower == 'sophia' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
              {% elif persona|lower == 'oliver' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 2a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6z"/>
              </svg>
              {% else %}
              {{ persona|default('I')|first|upper }}
              {% endif %}
            </div>
            <div>
              <div class="fw-medium">{{ persona|default('isabella')|capitalize }}</div>
              <div class="text-muted small">AI Companion</div>
            </div>
          </div>
          <div class="d-flex gap-3 align-items-center">
            <div class="avatar-select d-flex align-items-center gap-2" role="tablist" aria-label="Select companion">
              <button type="button" class="btn btn-sm p-0" data-persona="isabella" title="Isabella">
                <img src="{{ url_for('static', filename='avatars/isabella_small.png') }}" alt="Isabella" width="40" height="40" class="rounded avatar-img" />
              </button>
              <button type="button" class="btn btn-sm p-0" data-persona="sarai" title="Sarai">
                <img src="{{ url_for('static', filename='avatars/sarai_small.png') }}" alt="Sarai" width="40" height="40" class="rounded avatar-img" />
              </button>
              <button type="button" class="btn btn-sm p-0" data-persona="marie" title="Marie">
                <img src="{{ url_for('static', filename='avatars/marie_small.png') }}" alt="Marie" width="40" height="40" class="rounded avatar-img" />
              </button>
              <button type="button" class="btn btn-sm p-0" data-persona="alex" title="Alex">
                <img src="{{ url_for('static', filename='avatars/alex_small.png') }}" alt="Alex" width="40" height="40" class="rounded avatar-img" />
              </button>
            </div>
            <div class="d-flex flex-column">
              <span class="badge bg-primary bg-opacity-10 text-primary">Active</span>
              <span class="badge border text-secondary">Demo</span>
            </div>
          </div>
        </div>
        <div class="card-body chat-window">
          <div class="msg bot">
            <div class="fw-medium mb-1">{{ persona|default('isabella')|capitalize }}</div>
            Hi! I'm here to listen and support you. How are you feeling today?
          </div>
        </div>
        <div class="card-footer border-0 bg-white">
          <form class="d-flex gap-2" onsubmit="return false;">
            <input class="form-control" placeholder="Type your message..." />
            <button class="btn btn-primary px-4" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card mb-4 border-0">
        <div class="card-body">
          <h6 class="fw-medium mb-3">Conversation Mode</h6>
          <div class="btn-group w-100">
            <button class="btn btn-outline-primary">Wellness</button>
            <button class="btn btn-outline-primary active">Companion</button>
          </div>
          <div class="d-flex gap-2 mt-2">
            <span class="badge border text-secondary">16–17</span>
            <span class="badge border text-secondary">18+</span>
          </div>
        </div>
      </div>
      <div class="card border-0">
        <div class="card-body">
          <h6 class="fw-medium mb-3">Companions</h6>
          <div id="personaCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <div class="carousel-item active text-center">
                <img src="{{ url_for('static', filename='img/sarai.svg') }}" class="d-block mx-auto mb-3" alt="Sarai" style="width:100px;height:100px;border-radius:14px;" />
                <h6>Sarai • CBT</h6>
                <p class="small text-muted">Reframe • Memory Match</p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-sm btn-primary select-persona" data-persona="sarai">Select</button>
                  <button class="btn btn-sm btn-outline-secondary reset-memory" data-persona="sarai">Reset Memory</button>
                </div>
              </div>
              <div class="carousel-item text-center">
                <img src="{{ url_for('static', filename='img/marie.svg') }}" class="d-block mx-auto mb-3" alt="Marie" style="width:100px;height:100px;border-radius:14px;" />
                <h6>Marie • CBT</h6>
                <p class="small text-muted">Reframe • Voice</p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-sm btn-primary select-persona" data-persona="marie">Select</button>
                  <button class="btn btn-sm btn-outline-secondary reset-memory" data-persona="marie">Reset Memory</button>
                </div>
              </div>
              <div class="carousel-item text-center">
                <img src="{{ url_for('static', filename='img/alex.svg') }}" class="d-block mx-auto mb-3" alt="Alex" style="width:100px;height:100px;border-radius:14px;" />
                <h6>Alex • Companion</h6>
                <p class="small text-muted">Voice • Safety • Vault (PIN)</p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-sm btn-primary select-persona" data-persona="alex">Select</button>
                  <button class="btn btn-sm btn-outline-secondary reset-memory" data-persona="alex">Reset Memory</button>
                </div>
              </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#personaCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#personaCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Voice Upload Modal -->
<div class="modal fade" id="voiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload Custom Voice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Persona</label>
          <input type="text" class="form-control" id="voicePersona" value="{{ persona|default('isabella')|capitalize }}" />
        </div>
        <div class="mb-3">
          <label class="form-label">Voice Name (optional)</label>
          <input type="text" class="form-control" id="voiceName" placeholder="e.g., ClaraCustom" />
        </div>
        <div class="mb-3">
          <label class="form-label">Audio File (.mp3 / .wav / .m4a)</label>
          <input type="file" class="form-control" id="voiceFile" accept=".mp3,.wav,.m4a,audio/*" />
        </div>
        <div class="small text-muted">Tip: 30s–3min sample gives better cloning results.</div>
        <div id="voiceUploadStatus" class="mt-2 small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="uploadVoiceBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up me-2" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z"/>
            <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
          </svg>
          Upload & Create Voice
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // initialize avatar active state
  (function(){
    try{
      const persona = "{{ persona|default('isabella')|lower }}";
      document.querySelectorAll('.avatar-select button[data-persona]').forEach(b=>{
        if (b.dataset.persona === persona) b.classList.add('active');
      });
    }catch(e){/* ignore in templates */}
  })();
</script>
{% endblock %}