{% extends "base.html" %}

{% block title %}Mood Tracking - MyBella{% endblock %}

{% block extra_css %}
<style>
.mood-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.mood-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: white;
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
}

.mood-entry-form {
    background: var(--surface-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    border: 1px solid var(--border-color);
    margin-bottom: var(--spacing-xl);
}

.mood-scale-large {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--spacing-md);
    margin: var(--spacing-lg) 0;
}

.mood-option-large {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-lg);
    border: 3px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--surface-color);
}

.mood-option-large:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.mood-option-large.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.mood-emoji-large {
    font-size: 3rem;
    margin-bottom: var(--spacing-md);
}

.mood-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: var(--spacing-sm);
}

.mood-description {
    font-weight: 600;
    text-align: center;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.mood-details {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
}

.energy-scale {
    background: var(--background-color);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    margin: var(--spacing-lg) 0;
}

.scale-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin: var(--spacing-md) 0;
}

.scale-label {
    min-width: 80px;
    font-weight: 600;
    color: var(--text-primary);
}

.scale-input {
    flex: 1;
    margin: 0 var(--spacing-md);
}

.scale-value {
    min-width: 30px;
    text-align: center;
    font-weight: 700;
    color: var(--primary);
}

.factors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md);
    margin: var(--spacing-lg) 0;
}

.factor-chip {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    padding: var(--spacing-sm) var(--spacing-md);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.factor-chip:hover {
    border-color: var(--primary);
}

.factor-chip.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.mood-history {
    background: var(--surface-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    border: 1px solid var(--border-color);
    margin-bottom: var(--spacing-xl);
}

.history-filters {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
}

.filter-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--background-color);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.mood-chart {
    height: 300px;
    background: var(--background-color);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-style: italic;
    margin-bottom: var(--spacing-lg);
}

.mood-entries {
    display: grid;
    gap: var(--spacing-md);
    max-height: 400px;
    overflow-y: auto;
}

.mood-entry {
    background: var(--background-color);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.entry-mood {
    font-size: 2rem;
    min-width: 60px;
    text-align: center;
}

.entry-content {
    flex: 1;
}

.entry-date {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.entry-factors {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-xs);
}

.entry-factor {
    background: var(--primary-light);
    color: var(--primary);
    padding: 2px var(--spacing-xs);
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
}

.entry-note {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-style: italic;
}

.mood-insights {
    background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-xl);
    border: 1px solid #d4edda;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
}

.insight-card {
    background: white;
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.insight-icon {
    font-size: 2rem;
    text-align: center;
    margin-bottom: var(--spacing-md);
}

.insight-title {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: var(--spacing-sm);
    text-align: center;
}

.insight-value {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: var(--spacing-sm);
}

.insight-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
}

@media (max-width: 768px) {
    .mood-container {
        padding: var(--spacing-md);
    }
    
    .mood-scale-large {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .mood-option-large {
        padding: var(--spacing-md);
    }
    
    .mood-emoji-large {
        font-size: 2rem;
    }
    
    .history-filters {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="mood-container">
    <!-- Header -->
    <div class="mood-header">
        <h1> Mood Tracking</h1>
        <p>Track your emotions and discover patterns in your mental wellness</p>
    </div>

    <!-- Mood Entry Form -->
    <div class="mood-entry-form">
        <h2> How are you feeling today?</h2>
        
        <form id="mood-form">
            <!-- Mood Scale -->
            <div class="form-group">
                <label class="form-label">Select your overall mood (1-10):</label>
                <div class="mood-scale-large">
                    <div class="mood-option-large" onclick="selectMood(2, this)">
                        <div class="mood-emoji-large"></div>
                        <div class="mood-number">1-2</div>
                        <div class="mood-description">Very Low</div>
                        <div class="mood-details">Depressed, hopeless</div>
                    </div>
                    
                    <div class="mood-option-large" onclick="selectMood(4, this)">
                        <div class="mood-emoji-large"></div>
                        <div class="mood-number">3-4</div>
                        <div class="mood-description">Low</div>
                        <div class="mood-details">Sad, anxious</div>
                    </div>
                    
                    <div class="mood-option-large" onclick="selectMood(5, this)">
                        <div class="mood-emoji-large"></div>
                        <div class="mood-number">5</div>
                        <div class="mood-description">Neutral</div>
                        <div class="mood-details">Balanced, calm</div>
                    </div>
                    
                    <div class="mood-option-large" onclick="selectMood(7, this)">
                        <div class="mood-emoji-large"></div>
                        <div class="mood-number">6-7</div>
                        <div class="mood-description">Good</div>
                        <div class="mood-details">Happy, content</div>
                    </div>
                    
                    <div class="mood-option-large" onclick="selectMood(9, this)">
                        <div class="mood-emoji-large"></div>
                        <div class="mood-number">8-10</div>
                        <div class="mood-description">Excellent</div>
                        <div class="mood-details">Joyful, energetic</div>
                    </div>
                </div>
            </div>

            <!-- Energy & Stress Levels -->
            <div class="energy-scale">
                <h3> Energy & Stress Levels</h3>
                
                <div class="scale-container">
                    <label class="scale-label">Energy:</label>
                    <input type="range" id="energy-level" name="energy-level" min="1" max="10" value="5" class="scale-input"
                           oninput="document.getElementById('energy-value').textContent = this.value">
                    <span class="scale-value" id="energy-value">5</span>
                </div>
                
                <div class="scale-container">
                    <label class="scale-label">Stress:</label>
                    <input type="range" id="stress-level" name="stress-level" min="1" max="10" value="5" class="scale-input"
                           oninput="document.getElementById('stress-value').textContent = this.value">
                    <span class="scale-value" id="stress-value">5</span>
                </div>
                
                <div class="scale-container">
                    <label class="scale-label">Anxiety:</label>
                    <input type="range" id="anxiety-level" name="anxiety-level" min="1" max="10" value="5" class="scale-input"
                           oninput="document.getElementById('anxiety-value').textContent = this.value">
                    <span class="scale-value" id="anxiety-value">5</span>
                </div>
            </div>

            <!-- Mood Factors -->
            <div class="form-group">
                <label class="form-label">What's affecting your mood today? (Select all that apply)</label>
                <div class="factors-grid">
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="work"> Work</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="relationships"> Relationships</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="health"> Health</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="money"> Money</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="sleep"> Sleep</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="exercise"> Exercise</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="weather"> Weather</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="social"> Social</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="family"> Family</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="news"> News</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="achievement"> Achievement</div>
                    <div class="factor-chip" onclick="toggleFactor(this)" data-factor="creativity"> Creativity</div>
                </div>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label for="mood-notes" class="form-label">Additional notes (optional):</label>
                <textarea id="mood-notes" name="mood-notes" class="form-textarea" 
                          placeholder="Describe your day, what went well, challenges you faced..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary"> Save Mood Entry</button>
        </form>
    </div>

    <!-- Mood Insights -->
    <div class="mood-insights">
        <h2> Your Mood Insights</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-icon"></div>
                <div class="insight-title">Average Mood</div>
                <div class="insight-value">{{ average_mood or '7.2' }}</div>
                <div class="insight-description">This week</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-icon"></div>
                <div class="insight-title">Mood Trend</div>
                <div class="insight-value">{{ mood_trend or '+0.8' }}</div>
                <div class="insight-description">Improving!</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-icon"></div>
                <div class="insight-title">Logging Streak</div>
                <div class="insight-value">{{ logging_streak or '12' }} days</div>
                <div class="insight-description">Keep it up!</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-icon"></div>
                <div class="insight-title">Best Day</div>
                <div class="insight-value">{{ best_day or 'Monday' }}</div>
                <div class="insight-description">Highest average mood</div>
            </div>
        </div>
    </div>

    <!-- Mood History -->
    <div class="mood-history">
        <h2> Mood History</h2>
        
        <!-- Filters -->
        <div class="history-filters">
            <button class="filter-btn active" onclick="filterHistory('week')">This Week</button>
            <button class="filter-btn" onclick="filterHistory('month')">This Month</button>
            <button class="filter-btn" onclick="filterHistory('3months')">3 Months</button>
            <button class="filter-btn" onclick="filterHistory('year')">This Year</button>
        </div>
        
        <!-- Chart Placeholder -->
        <div class="mood-chart">
             Mood Chart (Chart.js integration coming soon)
        </div>
        
        <!-- Recent Entries -->
        <h3>Recent Entries</h3>
        <div class="mood-entries" id="mood-entries">
            <!-- Sample entries - will be populated dynamically -->
            <div class="mood-entry">
                <div class="entry-mood"></div>
                <div class="entry-content">
                    <div class="entry-date">Today, 2:30 PM</div>
                    <div class="entry-factors">
                        <span class="entry-factor">work</span>
                        <span class="entry-factor">exercise</span>
                    </div>
                    <div class="entry-note">Had a productive day and got to the gym!</div>
                </div>
            </div>
            
            <div class="mood-entry">
                <div class="entry-mood"></div>
                <div class="entry-content">
                    <div class="entry-date">Yesterday, 8:15 PM</div>
                    <div class="entry-factors">
                        <span class="entry-factor">stress</span>
                        <span class="entry-factor">sleep</span>
                    </div>
                    <div class="entry-note">Feeling tired after a long work week</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMood = null;
let selectedFactors = [];

function selectMood(value, element) {
    // Remove previous selection
    document.querySelectorAll('.mood-option-large').forEach(el => el.classList.remove('selected'));
    
    // Add selection to clicked element
    element.classList.add('selected');
    selectedMood = value;
}

function toggleFactor(element) {
    element.classList.toggle('selected');
    const factor = element.dataset.factor;
    
    if (selectedFactors.includes(factor)) {
        selectedFactors = selectedFactors.filter(f => f !== factor);
    } else {
        selectedFactors.push(factor);
    }
}

function filterHistory(period) {
    // Update filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Load mood history for the selected period
    loadMoodHistory(period);
}

function loadMoodHistory(period) {
    fetch(`{{ url_for('wellness.mood_history') }}?period=${period}`)
    .then(response => response.json())
    .then(data => {
        updateMoodEntries(data.entries);
        // Update chart with new data
        console.log('Mood history:', data);
    })
    .catch(error => {
        console.error('Error loading mood history:', error);
    });
}

function updateMoodEntries(entries) {
    const container = document.getElementById('mood-entries');
    container.innerHTML = '';
    
    entries.forEach(entry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'mood-entry';
        
        const moodEmoji = getMoodEmoji(entry.mood_scale);
        const factors = entry.factors ? entry.factors.map(f => `<span class="entry-factor">${f}</span>`).join('') : '';
        
        entryElement.innerHTML = `
            <div class="entry-mood">${moodEmoji}</div>
            <div class="entry-content">
                <div class="entry-date">${formatDate(entry.created_at)}</div>
                <div class="entry-factors">${factors}</div>
                <div class="entry-note">${entry.notes || 'No notes'}</div>
            </div>
        `;
        
        container.appendChild(entryElement);
    });
}

function getMoodEmoji(mood) {
    if (mood <= 2) return '';
    if (mood <= 4) return '';
    if (mood <= 5) return '';
    if (mood <= 7) return '';
    return '';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return 'Today, ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    if (days === 1) return 'Yesterday, ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    return date.toLocaleDateString() + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Form submission
document.getElementById('mood-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedMood) {
        alert('Please select your mood level');
        return;
    }
    
    const formData = {
        mood_scale: selectedMood,
        energy_level: document.getElementById('energy-level').value,
        stress_level: document.getElementById('stress-level').value,
        anxiety_level: document.getElementById('anxiety-level').value,
        factors: selectedFactors,
        notes: document.getElementById('mood-notes').value
    };
    
    fetch('{{ url_for("wellness.log_mood_entry") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(' Mood logged successfully!');
            // Reset form
            selectedMood = null;
            selectedFactors = [];
            document.querySelectorAll('.mood-option-large').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.factor-chip').forEach(el => el.classList.remove('selected'));
            document.getElementById('mood-form').reset();
            
            // Reload mood history
            loadMoodHistory('week');
        } else {
            alert(' Error logging mood: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(' Failed to log mood');
    });
});

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadMoodHistory('week');
});
</script>
{% endblock %}