{% extends "base.html" %}

{% block title %}Profile - MyBella{% endblock %}

{% block extra_css %}
<style>
.profile-container {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-md);
}

.profile-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: var(--spacing-2xl);
    border-radius: var(--radius-xl);
    margin-bottom: var(--spacing-xl);
    text-align: center;
}

.profile-avatar-section {
    margin-bottom: var(--spacing-lg);
}

.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    margin: 0 auto var(--spacing-md);
    overflow: hidden;
    position: relative;
    cursor: pointer;
}

.avatar-upload-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: var(--spacing-sm);
    text-align: center;
    font-size: var(--font-size-sm);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.profile-avatar:hover .avatar-upload-overlay {
    opacity: 1;
}

.profile-sections {
    display: grid;
    gap: var(--spacing-xl);
}

.profile-section {
    background: var(--surface-color);
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.section-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.section-title {
    font-size: var(--font-size-xl);
    font-weight: 600;
    margin: 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
}

.subscription-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: var(--background-color);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
}

.status-badge {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.status-active {
    background: rgb(16 185 129 / 0.1);
    color: var(--success-color);
}

.status-inactive {
    background: rgb(239 68 68 / 0.1);
    color: var(--error-color);
}

.minutes-display {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    text-align: center;
    margin-bottom: var(--spacing-md);
}

.minutes-number {
    font-size: var(--font-size-3xl);
    font-weight: 700;
    margin-bottom: var(--spacing-sm);
}

.activity-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md);
}

.activity-stat {
    text-align: center;
    padding: var(--spacing-md);
    background: var(--background-color);
    border-radius: var(--radius-md);
}

.activity-number {
    font-size: var(--font-size-2xl);
    font-weight: 600;
    color: var(--primary-color);
}

.activity-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-top: var(--spacing-xs);
}

/* Experience Mode Styles */
.experience-mode-display {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.mode-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    border: 2px solid;
    background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
}

.wellness-mode {
    border-color: #10B981;
    background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
}

.companion-mode {
    border-color: #EC4899;
    background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(236,72,153,0.05));
}

.mode-icon {
    font-size: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mode-content {
    flex: 1;
}

.mode-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
}

.wellness-mode .mode-title {
    color: #10B981;
}

.companion-mode .mode-title {
    color: #EC4899;
}

.mode-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.mode-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-weight: 600;
    font-size: var(--font-size-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.05);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

.status-wellness {
    background: #10B981;
}

.status-companion {
    background: #EC4899;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.mode-description {
    background: var(--background-color);
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.mode-description h4 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: var(--font-size-lg);
    color: var(--text-primary);
}

.mode-description > p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--spacing-lg);
}

.mode-features {
    display: grid;
    gap: var(--spacing-lg);
}

.feature-category h5 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: var(--font-size-md);
    color: var(--text-primary);
}

.feature-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: var(--spacing-sm);
}

.feature-list li {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    line-height: 1.5;
}

.feature-list-available li {
    background: rgba(16, 185, 129, 0.05);
    border-left: 3px solid #10B981;
}

.feature-list-restricted li {
    background: rgba(107, 114, 128, 0.05);
    border-left: 3px solid var(--text-muted);
    opacity: 0.7;
}

.feature-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.unlock-info {
    margin-top: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    background: rgba(236, 72, 153, 0.1);
    border-radius: var(--radius-md);
    border-left: 3px solid #EC4899;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.mode-note {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-md);
    background: rgba(59, 130, 246, 0.05);
    border-radius: var(--radius-md);
    border-left: 3px solid #3B82F6;
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--text-secondary);
}

.mode-security-note {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: rgba(245, 158, 11, 0.05);
    border-radius: var(--radius-md);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.security-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.security-text {
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--text-secondary);
}

.info-tooltip {
    cursor: help;
    display: inline-flex;
    align-items: center;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .subscription-status {
        flex-direction: column;
        gap: var(--spacing-sm);
        text-align: center;
    }
    
    .mode-badge {
        flex-direction: column;
        text-align: center;
    }
    
    .mode-features {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-avatar-section">
            <div class="profile-avatar" onclick="triggerAvatarUpload()">
                {% if current_user.profile_picture %}
                    <img src="{{ url_for('static', filename='uploads/profile_pics/' + current_user.profile_picture) }}" 
                         alt="{{ current_user.name }}" 
                         style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <div class="avatar avatar-xl bg-primary" style="background: rgba(255, 255, 255, 0.2); color: white; font-size: 3rem;">
                        {{ current_user.name[0].upper() }}
                    </div>
                {% endif %}
                <div class="avatar-upload-overlay">
                     Change Photo
                </div>
            </div>
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
        </div>
        
        <h1>{{ current_user.name }}</h1>
        <p>Member since {{ current_user.created_at.strftime('%B %Y') if current_user.created_at else 'Unknown' }}</p>
    </div>

    <!-- Profile Sections -->
    <div class="profile-sections">
        <!-- Personal Information -->
        <div class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Personal Information</h3>
                <button class="btn btn-secondary btn-sm" onclick="toggleEdit('personal')">Edit</button>
            </div>
            
            <form id="personalForm" onsubmit="savePersonalInfo(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" value="{{ current_user.name }}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" value="{{ current_user.email }}" name="email" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <input type="text" class="form-input" value="{{ current_user.gender.title() if current_user.gender else 'Not specified' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Default AI Companion</label>
                        <input type="text" class="form-input" value="{{ current_user.get_default_persona() if current_user.gender else 'Isabella' }}" readonly>
                        <small class="text-muted">{{ 'Assigned based on your gender preference' if current_user.gender else 'Default assignment' }}</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input form-textarea" name="bio" placeholder="Tell us about yourself..." readonly>{{ current_user.bio or '' }}</textarea>
                </div>
                
                <div class="hidden" id="personalActions">
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('personal')">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Experience Mode -->
        <div class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Experience Mode</h3>
                <div class="info-tooltip" title="Experience mode is automatically set based on your age and cannot be changed manually">
                    <span style="font-size: 1.2rem; color: var(--text-muted); cursor: help;">i</span>
                </div>
            </div>
            
            <div class="experience-mode-display">
                {% set age_info = age_verification_info %}
                {% if age_info and age_info.is_teen %}
                    <div class="mode-badge wellness-mode">
                        <div class="mode-icon">W</div>
                        <div class="mode-content">
                            <div class="mode-title">Wellness Mode</div>
                            <div class="mode-subtitle">Ages 16-17</div>
                        </div>
                        <div class="mode-status">
                            <span class="status-dot status-wellness"></span>
                            Active
                        </div>
                    </div>
                    
                    <div class="mode-description">
                        <h4>Your Wellness-Focused Experience</h4>
                        <p>As a teen user, you have access to our supportive wellness features designed to help with mental health, productivity, and personal growth.</p>
                        
                        <div class="mode-features">
                            <div class="feature-category">
                                <h5>Available Features:</h5>
                                <ul class="feature-list feature-list-available">
                                    <li>CBT Games & Mental Health Exercises</li>
                                    <li>Mood Timeline & Emotional Tracking</li>
                                    <li>Secrets Vault (PIN-Protected Journal)</li>
                                    <li>Supportive AI Companions</li>
                                    <li>Study Companion & Productivity Tools</li>
                                    <li>Voice Chat (Supportive Mode)</li>
                                    <li>Wellness Avatars & Customization</li>
                                    <li>Streak Rewards & Achievements</li>
                                </ul>
                            </div>
                            
                            <div class="feature-category">
                                <h5>Restricted (Available at 18+):</h5>
                                <ul class="feature-list feature-list-restricted">
                                    <li>Intimacy & Romance Modes</li>
                                    <li>Love Letters & Romantic Messages</li>
                                    <li>WhisperTalk (TM) Romantic Voice</li>
                                    <li>Romantic Avatars & Themes</li>
                                </ul>
                                <p class="unlock-info">
                                    <strong>Full features unlock {{ age_info.years_until_adult if age_info.years_until_adult else 'soon' }}!</strong>
                                </p>
                            </div>
                        </div>
                        
                        <div class="mode-note">
                            <strong>Note:</strong> Your AI companions adapt their tone to be supportive and wellness-focused, acting like caring friends, siblings, or mentors.
                        </div>
                    </div>
                {% else %}
                    <div class="mode-badge companion-mode">
                        <div class="mode-icon">C</div>
                        <div class="mode-content">
                            <div class="mode-title">Companion Mode</div>
                            <div class="mode-subtitle">Ages 18+</div>
                        </div>
                        <div class="mode-status">
                            <span class="status-dot status-companion"></span>
                            Active
                        </div>
                    </div>
                    
                    <div class="mode-description">
                        <h4>Full Feature Access</h4>
                        <p>You have complete access to all MyBella features, including romantic companionship, intimacy modes, and wellness tools.</p>
                        
                        <div class="mode-features">
                            <div class="feature-category">
                                <h5>All Features Unlocked:</h5>
                                <ul class="feature-list feature-list-available">
                                    <li>Intimacy & Time-Grown Relationship Modes</li>
                                    <li>Love Letters & Romantic Daily Messages</li>
                                    <li>WhisperTalk (TM) Romantic Voice Modes</li>
                                    <li>Romantic Avatars & Intimate Themes</li>
                                    <li>CBT Games & Mental Health Tools</li>
                                    <li>Mood Timeline & Analytics</li>
                                    <li>Secrets Vault & Private Journaling</li>
                                    <li>Full Voice Chat with All Modes</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mode-note">
                            <strong>Note:</strong> Your AI companions can express full emotional depth, from supportive friendship to romantic connection, adapting to your relationship preferences.
                        </div>
                    </div>
                {% endif %}
                
                <div class="mode-security-note">
                    <div class="security-icon">SECURE</div>
                    <div class="security-text">
                        <strong>Security Notice:</strong> Experience mode is determined by your verified date of birth and is enforced server-side. This setting cannot be manually changed for safety and compliance reasons.
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Information -->
        <div class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Subscription</h3>
                <button class="btn btn-primary btn-sm">Upgrade Plan</button>
            </div>
            
            <div class="subscription-status">
                <div>
                    <strong>Current Plan:</strong> {{ subscription_info.plan_name if subscription_info else 'Free' }}
                </div>
                <div class="status-badge {{ 'status-active' if subscription_info and subscription_info.is_active else 'status-inactive' }}">
                    {{ 'Active' if subscription_info and subscription_info.is_active else 'Inactive' }}
                </div>
            </div>
            
            {% if subscription_info %}
            <div class="minutes-display">
                <div class="minutes-number">{{ subscription_info.minutes_remaining }}</div>
                <div>Voice Chat Minutes Remaining</div>
            </div>
            {% endif %}
            
            <div class="activity-summary">
                <div class="activity-stat">
                    <div class="activity-number">{{ stats.total_messages or 0 }}</div>
                    <div class="activity-label">Messages Sent</div>
                </div>
                <div class="activity-stat">
                    <div class="activity-number">{{ stats.total_voice_calls or 0 }}</div>
                    <div class="activity-label">Voice Chats</div>
                </div>
                <div class="activity-stat">
                    <div class="activity-number">{{ stats.favorite_personas or 4 }}</div>
                    <div class="activity-label">Favorite Personas</div>
                </div>
                <div class="activity-stat">
                    <div class="activity-number">{{ stats.total_minutes or 0 }}</div>
                    <div class="activity-label">Minutes Used</div>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Security</h3>
            </div>
            
            <form id="securityForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" name="current_password" placeholder="Enter current password">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" name="new_password" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" name="confirm_password" placeholder="Confirm new password">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Change Password</button>
            </form>
        </div>

        <!-- Preferences -->
        <div class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Preferences</h3>
            </div>
            
            <form id="preferencesForm" onsubmit="savePreferences(event)">
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox mr-2" name="notifications" checked>
                        Enable notifications
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox mr-2" name="voice_calls" checked>
                        Allow voice chat
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox mr-2" name="auto_save_chats" checked>
                        Auto-save chat history
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Preferences</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function triggerAvatarUpload() {
    document.getElementById('avatarUpload').click();
}

async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('profile_picture', file);
    
    try {
        const response = await fetch('/api/profile/upload-avatar', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload(); // Refresh to show new avatar
        } else {
            myBella.showAlert(data.error || 'Failed to upload avatar', 'error');
        }
    } catch (error) {
        myBella.showAlert('Failed to upload avatar', 'error');
    }
}

function toggleEdit(section) {
    const form = document.getElementById(`${section}Form`);
    const inputs = form.querySelectorAll('input[readonly], textarea[readonly]');
    const actions = document.getElementById(`${section}Actions`);
    
    inputs.forEach(input => {
        input.removeAttribute('readonly');
        input.classList.add('editable');
    });
    
    actions.classList.remove('hidden');
}

function cancelEdit(section) {
    location.reload(); // Simple way to cancel changes
}

async function savePersonalInfo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/profile/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            myBella.showAlert('Profile updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            myBella.showAlert(result.error || 'Failed to update profile', 'error');
        }
    } catch (error) {
        myBella.showAlert('Failed to update profile', 'error');
    }
}

async function changePassword(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    if (data.new_password !== data.confirm_password) {
        myBella.showAlert('Passwords do not match', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: data.current_password,
                new_password: data.new_password
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            myBella.showAlert('Password changed successfully!', 'success');
            event.target.reset();
        } else {
            myBella.showAlert(result.error || 'Failed to change password', 'error');
        }
    } catch (error) {
        myBella.showAlert('Failed to change password', 'error');
    }
}

async function savePreferences(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const preferences = {
        notifications: formData.has('notifications'),
        voice_calls: formData.has('voice_calls'),
        auto_save_chats: formData.has('auto_save_chats')
    };
    
    try {
        const response = await fetch('/api/profile/preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        });
        
        const result = await response.json();
        
        if (result.success) {
            myBella.showAlert('Preferences saved!', 'success');
        } else {
            myBella.showAlert(result.error || 'Failed to save preferences', 'error');
        }
    } catch (error) {
        myBella.showAlert('Failed to save preferences', 'error');
    }
}
</script>
{% endblock %}