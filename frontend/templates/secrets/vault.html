{% extends "base.html" %}

{% block title %}Secrets Vault - MyBella{% endblock %}

{% block content %}
<div class="vault-container">
    <!-- PIN Setup/Unlock Screen -->
    <div id="pinScreen" class="pin-screen {% if has_vault %}hidden{% endif %}">
        <div class="pin-card">
            <div class="vault-icon">üîê</div>
            <h1>Secrets Vault</h1>
            <p class="vault-subtitle">Your private, PIN-protected journal</p>
            
            <div id="setupMode" {% if has_vault %}class="hidden"{% endif %}>
                <p class="pin-instruction">Set a 4-digit PIN to protect your secrets</p>
                <div class="pin-input-group">
                    <input type="password" maxlength="1" class="pin-digit" data-index="0">
                    <input type="password" maxlength="1" class="pin-digit" data-index="1">
                    <input type="password" maxlength="1" class="pin-digit" data-index="2">
                    <input type="password" maxlength="1" class="pin-digit" data-index="3">
                </div>
                <button class="btn-vault" onclick="setupPIN()">Set PIN</button>
                <p class="pin-note">‚ö†Ô∏è Remember your PIN - it cannot be recovered</p>
            </div>
            
            <div id="unlockMode" {% if not has_vault %}class="hidden"{% endif %}>
                <p class="pin-instruction">Enter your PIN to unlock the vault</p>
                <div class="pin-input-group">
                    <input type="password" maxlength="1" class="pin-digit-unlock" data-index="0">
                    <input type="password" maxlength="1" class="pin-digit-unlock" data-index="1">
                    <input type="password" maxlength="1" class="pin-digit-unlock" data-index="2">
                    <input type="password" maxlength="1" class="pin-digit-unlock" data-index="3">
                </div>
                <button class="btn-vault" onclick="unlockVault()">Unlock</button>
                <div id="pinError" class="pin-error hidden">‚ùå Incorrect PIN</div>
            </div>
        </div>
    </div>

    <!-- Vault Content (hidden until unlocked) -->
    <div id="vaultContent" class="vault-content hidden">
        <div class="vault-header">
            <div class="header-left">
                <h1>üîê Secrets Vault</h1>
                <p class="vault-stats" id="vaultStats">Loading...</p>
            </div>
            <div class="header-actions">
                <button class="btn-new-entry" onclick="showNewEntryModal()">+ New Entry</button>
                <button class="btn-lock" onclick="lockVault()">üîí Lock</button>
            </div>
        </div>

        <div class="entries-grid" id="entriesGrid">
            <div class="loading">Loading your secrets...</div>
        </div>
    </div>

    <!-- New Entry Modal -->
    <div id="newEntryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Secret Entry</h2>
                <button class="close-btn" onclick="closeNewEntryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="entryTitle" placeholder="Title" class="form-input" maxlength="200">
                <textarea id="entryContent" placeholder="Write your secret thoughts..." class="form-textarea" rows="10"></textarea>
                <div class="mood-selector">
                    <label>How are you feeling?</label>
                    <select id="entryMood" class="form-select">
                        <option value="">Not specified</option>
                        <option value="happy">üòä Happy</option>
                        <option value="sad">üò¢ Sad</option>
                        <option value="anxious">üò∞ Anxious</option>
                        <option value="excited">ü§© Excited</option>
                        <option value="grateful">üôè Grateful</option>
                        <option value="angry">üò† Angry</option>
                        <option value="peaceful">üòå Peaceful</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeNewEntryModal()">Cancel</button>
                <button class="btn-save" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>

    <!-- View Entry Modal -->
    <div id="viewEntryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewEntryTitle"></h2>
                <button class="close-btn" onclick="closeViewEntryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="viewEntryContent" class="entry-content-display"></div>
                <div id="viewEntryMood" class="entry-mood-display"></div>
                <div id="viewEntryDate" class="entry-date-display"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-delete" onclick="deleteCurrentEntry()">Delete</button>
                <button class="btn-close" onclick="closeViewEntryModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.vault-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
}

.pin-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
}

.pin-card {
    background: white;
    border-radius: 24px;
    padding: 3rem;
    max-width: 500px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.vault-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.vault-subtitle {
    color: #7f8c8d;
    margin-bottom: 2rem;
}

.pin-instruction {
    margin-bottom: 1.5rem;
    font-size: 1.1rem;
    color: #2c3e50;
}

.pin-input-group {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
}

.pin-digit, .pin-digit-unlock {
    width: 60px;
    height: 70px;
    font-size: 2rem;
    text-align: center;
    border: 2px solid #ddd;
    border-radius: 12px;
    outline: none;
    transition: all 0.3s;
}

.pin-digit:focus, .pin-digit-unlock:focus {
    border-color: #667eea;
    transform: scale(1.05);
}

.btn-vault {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1rem 3rem;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-vault:hover {
    transform: translateY(-2px);
}

.pin-note {
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #e74c3c;
}

.pin-error {
    margin-top: 1rem;
    color: #e74c3c;
    font-weight: 600;
}

.vault-content {
    max-width: 1200px;
    margin: 0 auto;
}

.vault-header {
    background: white;
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.vault-header h1 {
    margin: 0;
    color: #2c3e50;
}

.vault-stats {
    color: #7f8c8d;
    margin: 0.5rem 0 0 0;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn-new-entry {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-new-entry:hover {
    transform: translateY(-2px);
}

.btn-lock {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
}

.entries-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.entry-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.entry-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.entry-card-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.entry-card-preview {
    color: #7f8c8d;
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 1rem;
    max-height: 60px;
    overflow: hidden;
}

.entry-card-date {
    font-size: 0.85rem;
    color: #95a5a6;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: white;
    border-radius: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 2rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #95a5a6;
}

.modal-body {
    padding: 2rem;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 12px;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.form-textarea {
    resize: vertical;
    font-family: inherit;
}

.modal-footer {
    padding: 2rem;
    border-top: 1px solid #eee;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-cancel, .btn-close {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    border: 2px solid #ddd;
    background: white;
    cursor: pointer;
}

.btn-save {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.btn-delete {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    border: none;
    background: #e74c3c;
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.hidden {
    display: none !important;
}

.loading {
    text-align: center;
    padding: 3rem;
    color: white;
    font-size: 1.2rem;
}

.entry-content-display {
    white-space: pre-wrap;
    line-height: 1.8;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.entry-mood-display, .entry-date-display {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-top: 0.5rem;
}
</style>

<script>
let currentPIN = null;
let currentEntryId = null;

// PIN input handling
document.addEventListener('DOMContentLoaded', function() {
    setupPINInputs('.pin-digit');
    setupPINInputs('.pin-digit-unlock');
});

function setupPINInputs(selector) {
    const inputs = document.querySelectorAll(selector);
    inputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            if (e.target.value.length === 1) {
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
        });
    });
}

function getPIN(selector) {
    const inputs = document.querySelectorAll(selector);
    return Array.from(inputs).map(i => i.value).join('');
}

async function setupPIN() {
    const pin = getPIN('.pin-digit');
    
    if (pin.length !== 4) {
        alert('Please enter a 4-digit PIN');
        return;
    }
    
    try {
        const response = await fetch('/secrets/api/setup-pin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pin})
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentPIN = pin;
            document.getElementById('pinScreen').classList.add('hidden');
            document.getElementById('vaultContent').classList.remove('hidden');
            loadEntries();
            loadStats();
        } else {
            alert(data.error || 'Failed to set PIN');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to set PIN');
    }
}

async function unlockVault() {
    const pin = getPIN('.pin-digit-unlock');
    
    if (pin.length !== 4) {
        alert('Please enter your 4-digit PIN');
        return;
    }
    
    try {
        const response = await fetch('/secrets/api/verify-pin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pin})
        });
        
        const data = await response.json();
        
        if (data.success && data.valid) {
            currentPIN = pin;
            document.getElementById('pinScreen').classList.add('hidden');
            document.getElementById('vaultContent').classList.remove('hidden');
            loadEntries();
            loadStats();
        } else {
            document.getElementById('pinError').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('pinError').classList.add('hidden');
            }, 3000);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to verify PIN');
    }
}

function lockVault() {
    currentPIN = null;
    document.getElementById('vaultContent').classList.add('hidden');
    document.getElementById('pinScreen').classList.remove('hidden');
    document.querySelectorAll('.pin-digit-unlock').forEach(input => input.value = '');
}

async function loadEntries() {
    try {
        const response = await fetch(`/secrets/api/entries?pin=${currentPIN}`);
        const data = await response.json();
        
        if (data.success) {
            renderEntries(data.entries);
        } else {
            alert(data.error || 'Failed to load entries');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load entries');
    }
}

function renderEntries(entries) {
    const grid = document.getElementById('entriesGrid');
    
    if (entries.length === 0) {
        grid.innerHTML = '<div class="loading">No entries yet. Create your first secret!</div>';
        return;
    }
    
    grid.innerHTML = entries.map(entry => `
        <div class="entry-card" onclick="viewEntry(${entry.id})">
            <div class="entry-card-title">${escapeHtml(entry.title)}</div>
            <div class="entry-card-preview">${escapeHtml(entry.content.substring(0, 100))}${entry.content.length > 100 ? '...' : ''}</div>
            <div class="entry-card-date">${new Date(entry.created_at).toLocaleDateString()}</div>
        </div>
    `).join('');
}

async function loadStats() {
    try {
        const response = await fetch(`/secrets/api/stats?pin=${currentPIN}`);
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('vaultStats').textContent = 
                `${stats.total_entries} entries ‚Ä¢ ${stats.total_words} words`;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function showNewEntryModal() {
    document.getElementById('newEntryModal').classList.remove('hidden');
    document.getElementById('entryTitle').value = '';
    document.getElementById('entryContent').value = '';
    document.getElementById('entryMood').value = '';
}

function closeNewEntryModal() {
    document.getElementById('newEntryModal').classList.add('hidden');
}

async function saveEntry() {
    const title = document.getElementById('entryTitle').value.trim();
    const content = document.getElementById('entryContent').value.trim();
    const mood = document.getElementById('entryMood').value;
    
    if (!title || !content) {
        alert('Please fill in title and content');
        return;
    }
    
    try {
        const response = await fetch('/secrets/api/entry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pin: currentPIN, title, content, mood})
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeNewEntryModal();
            loadEntries();
            loadStats();
        } else {
            alert(data.error || 'Failed to save entry');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to save entry');
    }
}

async function viewEntry(id) {
    try {
        const response = await fetch(`/secrets/api/entry/${id}?pin=${currentPIN}`);
        const data = await response.json();
        
        if (data.success) {
            const entry = data.entry;
            currentEntryId = id;
            document.getElementById('viewEntryTitle').textContent = entry.title;
            document.getElementById('viewEntryContent').textContent = entry.content;
            document.getElementById('viewEntryMood').textContent = entry.mood ? `Mood: ${entry.mood}` : '';
            document.getElementById('viewEntryDate').textContent = new Date(entry.created_at).toLocaleString();
            document.getElementById('viewEntryModal').classList.remove('hidden');
        } else {
            alert(data.error || 'Failed to load entry');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load entry');
    }
}

function closeViewEntryModal() {
    document.getElementById('viewEntryModal').classList.add('hidden');
    currentEntryId = null;
}

async function deleteCurrentEntry() {
    if (!currentEntryId) return;
    
    if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/secrets/api/entry/${currentEntryId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pin: currentPIN})
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeViewEntryModal();
            loadEntries();
            loadStats();
        } else {
            alert(data.error || 'Failed to delete entry');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete entry');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
