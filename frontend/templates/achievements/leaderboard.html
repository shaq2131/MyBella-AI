{% extends "base.html" %}

{% block title %}Leaderboard - MyBella{% endblock %}

{% block styles %}
<style>
    .leaderboard-container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 20px;
    }

    .leaderboard-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .leaderboard-header h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
    }

    .opt-in-section {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        text-align: center;
    }

    .opt-in-toggle {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: #ccc;
        border-radius: 30px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .toggle-switch.active {
        background: #FFD700;
    }

    .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(30px);
    }

    .user-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }

    .user-rank {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .user-name {
        font-size: 1.5rem;
        margin-bottom: 15px;
    }

    .user-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }

    .user-stat {
        text-align: center;
    }

    .user-stat-value {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .user-stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .leaderboard-list {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s ease;
    }

    .leaderboard-item:last-child {
        border-bottom: none;
    }

    .leaderboard-item:hover {
        background: #f8f9fa;
    }

    .rank {
        font-size: 1.5rem;
        font-weight: 700;
        width: 60px;
        text-align: center;
    }

    .rank.top1 {
        color: #FFD700;
        font-size: 2rem;
    }

    .rank.top2 {
        color: #C0C0C0;
        font-size: 1.8rem;
    }

    .rank.top3 {
        color: #CD7F32;
        font-size: 1.6rem;
    }

    .user-info {
        flex: 1;
        margin-left: 20px;
    }

    .display-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .user-metrics {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        color: #7f8c8d;
    }

    .metric {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .total-points {
        font-size: 1.5rem;
        font-weight: 700;
        color: #FFD700;
        margin-left: auto;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .actions-bar {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        text-decoration: none;
        color: white;
    }

    .btn-secondary {
        background: white;
        color: #FFD700;
        border: 2px solid #FFD700;
    }

    .btn-secondary:hover {
        background: #FFD700;
        color: white;
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .leaderboard-header h1 {
            font-size: 1.8rem;
        }

        .leaderboard-item {
            flex-wrap: wrap;
        }

        .total-points {
            width: 100%;
            margin-top: 10px;
            text-align: right;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="leaderboard-container">
    <!-- Header -->
    <div class="leaderboard-header">
        <h1> Leaderboard</h1>
        <p>See how you compare with other wellness warriors</p>
    </div>

    <!-- Opt-in Section -->
    <div class="opt-in-section">
        <h3>Join the Leaderboard</h3>
        <p>Opt in to share your progress and compete with the community</p>
        <div class="opt-in-toggle">
            <span>Private</span>
            <div class="toggle-switch {% if user_entry and user_entry.opt_in %}active{% endif %}" 
                 id="optInToggle" onclick="toggleOptIn()">
                <div class="toggle-slider"></div>
            </div>
            <span>Public</span>
        </div>
    </div>

    <!-- User's Position (if opted in) -->
    {% if user_entry and user_entry.opt_in %}
    <div class="user-card">
        <div class="user-rank">#{{ user_entry.rank or '?' }}</div>
        <div class="user-name">{{ user_entry.display_name }}</div>
        <div class="user-stats">
            <div class="user-stat">
                <div class="user-stat-value">{{ user_entry.total_points }}</div>
                <div class="user-stat-label">Points</div>
            </div>
            <div class="user-stat">
                <div class="user-stat-value">{{ user_entry.total_achievements }}</div>
                <div class="user-stat-label">Achievements</div>
            </div>
            <div class="user-stat">
                <div class="user-stat-value">{{ user_entry.current_streak }}</div>
                <div class="user-stat-label">Current Streak</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Leaderboard List -->
    {% if rankings %}
    <div class="leaderboard-list">
        {% for entry in rankings %}
            <div class="leaderboard-item">
                <div class="rank {% if entry.rank == 1 %}top1{% elif entry.rank == 2 %}top2{% elif entry.rank == 3 %}top3{% endif %}">
                    {% if entry.rank == 1 %}{% elif entry.rank == 2 %}{% elif entry.rank == 3 %}{% else %}#{{ entry.rank }}{% endif %}
                </div>
                
                <div class="user-info">
                    <div class="display-name">{{ entry.display_name }}</div>
                    <div class="user-metrics">
                        <div class="metric">
                            <span></span>
                            <span>{{ entry.total_achievements }} achievements</span>
                        </div>
                        <div class="metric">
                            <span></span>
                            <span>{{ entry.current_streak }} day streak</span>
                        </div>
                    </div>
                </div>
                
                <div class="total-points">{{ entry.total_points }}</div>
            </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"></div>
        <h3>No entries yet</h3>
        <p>Be the first to join the leaderboard by opting in above!</p>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="actions-bar">
        <a href="{{ url_for('achievements.dashboard') }}" class="btn btn-secondary">‚Üê Back to Achievements</a>
    </div>
</div>

<script>
async function toggleOptIn() {
    const toggle = document.getElementById('optInToggle');
    
    try {
        const response = await fetch('/achievements/api/toggle-opt-in', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.ok) {
            // Reload page to show updated status
            location.reload();
        }
    } catch (error) {
        console.error('Error toggling opt-in:', error);
    }
}
</script>
{% endblock %}
